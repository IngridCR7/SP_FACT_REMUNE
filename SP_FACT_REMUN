USE [COMPENSACION_TOTAL]
GO
/****** Object:  StoredProcedure [dbo].[SP_CARGA_FACT_REMUNERACION]    Script Date: 11/03/2024 23:30:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[SP_CARGA_FACT_REMUNERACION]
@ANIO_EJERCICIO INT
AS
BEGIN
--USE COMPENSACION_TOTAL

--DECLARE @ANIO_EJERCICIO INT = 2020
IF OBJECT_ID(N'TEMPDB..#PAGOS_EXCEPCION', N'U')					IS NOT NULL		 DROP TABLE #PAGOS_EXCEPCION;
IF OBJECT_ID(N'TEMPDB..#COLUMNAS_EXCEPCION', N'U')				IS NOT NULL		 DROP TABLE #COLUMNAS_EXCEPCION;
IF OBJECT_ID(N'TEMPDB..#SUB_GRUPOS', N'U')						IS NOT NULL		 DROP TABLE #SUB_GRUPOS;
IF OBJECT_ID(N'TEMPDB..#PAGOS_TOTAL_EJERCICIO', N'U')			IS NOT NULL		 DROP TABLE #PAGOS_TOTAL_EJERCICIO;
IF OBJECT_ID(N'TEMPDB..##TMP_PRE_FINAL', N'U')					IS NOT NULL		 DROP TABLE ##TMP_PRE_FINAL;

DECLARE @SQL NVARCHAR(MAX), @NO_GRUPO VARCHAR(250)

SELECT TOP 0 * INTO #PAGOS_EXCEPCION FROM COMPENSACION_TOTAL..HM_CONSOLIDADO_PAGOS

SELECT B.column_id -4 NU_ORDEN, B.name NO_COLUMNA
INTO #COLUMNAS_EXCEPCION
FROM SYS.all_objects A
INNER JOIN sys.all_columns B ON A.object_id = B.object_id
WHERE A.name = 'HM_REMUNERACION_EXCEPCION' AND column_id > 4

DECLARE @INI INT = 1 ,@COLUMNA VARCHAR(100)='',@FIN INT = (SELECT MAX(NU_ORDEN) FROM #COLUMNAS_EXCEPCION)
WHILE(@INI <= @FIN)
BEGIN
	SET @COLUMNA = (SELECT NO_COLUMNA FROM #COLUMNAS_EXCEPCION WHERE NU_ORDEN = @INI)
	SELECT @NO_GRUPO = NO_GRUPO FROM COMPENSACION_TOTAL..MA_AGRUPACIONES_PAGOS WHERE ANIO_EJERCICIO = @ANIO_EJERCICIO AND NO_SUB_GRUPO = @COLUMNA
	SET @SQL ='
				INSERT INTO #PAGOS_EXCEPCION
				SELECT CO_PERIODO_NOMINA,(('+CAST(@ANIO_EJERCICIO AS CHAR(4))+') *100 + 3) CO_PERIODO_PRODUCCION,NU_PERSONAL,ISNULL(['+@COLUMNA+'],0) MONTO,'''+@COLUMNA+''' NO_SUB_GRUPO, '''+@NO_GRUPO+''' NO_GRUPO   
				FROM COMPENSACION_TOTAL..HM_REMUNERACION_EXCEPCION 
				WHERE CO_PERIODO_NOMINA = (('+CAST(@ANIO_EJERCICIO AS CHAR(4))+' + 1) *100 + 3) AND ISNULL(['+@COLUMNA+'],0)> 0'
	EXEC( @SQL)
	SET @INI = @INI + 1
END

SELECT NU_PERSONAL,NO_SUB_GRUPO,SUM(MONTO)MONTO INTO #PAGOS_TOTAL_EJERCICIO FROM (
SELECT * FROM COMPENSACION_TOTAL..HM_CONSOLIDADO_PAGOS WHERE CO_PERIODO_PRODUCCION /100 = @ANIO_EJERCICIO
UNION ALL
SELECT * FROM #PAGOS_EXCEPCION)X
GROUP BY NU_PERSONAL,NO_SUB_GRUPO


DECLARE @NO_SUB_GRUPO VARCHAR(MAX)
SELECT DISTINCT NO_SUB_GRUPO INTO #SUB_GRUPOS FROM #PAGOS_TOTAL_EJERCICIO
SELECT @NO_SUB_GRUPO		   = COALESCE(@NO_SUB_GRUPO,'') +'['+NO_SUB_GRUPO +']'+ ','  FROM #SUB_GRUPOS 
SET @NO_SUB_GRUPO		   = substring(@NO_SUB_GRUPO,1,len(@NO_SUB_GRUPO)-1)

SET @SQL = ''
SET @SQL ='SELECT NU_PERSONAL,'+@NO_SUB_GRUPO+' INTO ##TMP_PRE_FINAL FROM #PAGOS_TOTAL_EJERCICIO PIVOT	(		SUM(MONTO)		FOR NO_SUB_GRUPO IN  ('+@NO_SUB_GRUPO+')	) AS P'
EXEC sp_executesql @SQL

--SELECT NU_PERSONAL,[Bono remunerativo],[Pagos adicionales],[Subsidios],[Acuerdos],[Remuneración fija],[PAU],[PUL],[Bono por Desempeño],[Remuneración variable],[Gratificación] INTO ##TMP_PRE_FINAL FROM #PAGOS_TOTAL_EJERCICIO PIVOT	(		SUM(MONTO)		FOR NO_SUB_GRUPO IN  ([Bono remunerativo],[Pagos adicionales],[Subsidios],[Acuerdos],[Remuneración fija],[PAU],[PUL],[Bono por Desempeño],[Remuneración variable],[Gratificación])	) AS P
--AGREGAMOS LOS CAMPOS ADICIONALES PARA INSERTAR
SET @NO_SUB_GRUPO = CONCAT('[ANIO_EJERCICIO]',',','[NU_PERSONAL]',',',@NO_SUB_GRUPO)
SET @SQL = ''
DELETE COMPENSACION_TOTAL..HM_FACT_REMUNERACION WHERE ANIO_EJERCICIO = @ANIO_EJERCICIO
SET @SQL = 'INSERT INTO COMPENSACION_TOTAL..HM_FACT_REMUNERACION ('+@NO_SUB_GRUPO+') SELECT '+CAST(@ANIO_EJERCICIO AS CHAR(4))+' ANIO_EJERCICIO,* FROM ##TMP_PRE_FINAL'
EXEC sp_executesql @SQL
--202420


END
